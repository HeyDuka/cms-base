Widget.types.media_object_edit = {
	prepare: function() {
		var _this = this;
		Widget.createWithElement('document_input', function(widget) {
			widget._element.prepend(jQuery('<option/>').attr('value', '').text('{{writeString=none}}'));
			_this.document_input = widget._element;
		});
		this.preview = this._element.find('.preview');
		this.config = this._element.find('.config');
		this.entry_prototype = jQuery.parseHTML('{{includeTemplate=entry}}');
		this._element.find('a').bind('click', function(event) {
			_this.add_entry();
		});
		this._element.delegate('input, select', 'change', function() {
			_this.update_preview();
		});
		this._element.delegate('.delete_media', 'click', function() {
			var delete_media = jQuery(this).closest('.media_entry');
			delete_media.remove();
			_this.update_preview();
		});
	},
	
	add_entry: function() {
		var new_entry = this.entry_prototype.clone();
		new_entry.find("label[for='document_id[]']").after(this.document_input.clone().attr('name', 'document_id[]'));
		this.config.append(new_entry);
		return new_entry;
	},
	
	update_preview: function() {
		this.renderPreview(this._element.serializeArrayKV(), function(result) {
			this.preview.empty().append(jQuery.parseHTML(result));
		});
	},
	
	save: function(callback) {
		this.saveData(this._element.serializeArrayKV(), callback);
	}
};