(function($) {
	var originalFix = $.event.fix;
	$.event.fix = function(event) {
		event = originalFix.call(this, event);
		if(event.type.indexOf('drag') == 0 || event.type.indexOf('drop') == 0 ) {
			event.dataTransfer = event.originalEvent.dataTransfer;
		}
		return event;
	}
})(jQuery);

Widget.types.file_upload = {
	initialize: function() {
	},
	
	allow_drag_to: function(element, selector, callback) {
		var file_upload = this;
		var current_drag_is_file = false;
		element.bind('dragenter', function(event) {
			current_drag_is_file = event.dataTransfer.files !== null || event.dataTransfer.types.contains("Files");
		}).bind('dragover', function(event) {
			if(!current_drag_is_file) {
				return;
			}
			element.find(selector).removeClass('ui-state-highlight');
			var target = jQuery(event.target);
			if(!target.is(selector)) {
				return;
			}
			target.addClass('ui-state-highlight');
			event.originalEvent.preventDefault();
			return false;
		}).bind('dragleave', function(event) {
			element.find(selector).removeClass('ui-state-highlight');
		}).bind('drop', function(event) {
			if(!current_drag_is_file || event.dataTransfer.files.length < 1) {
				Widget.notifyUser('info', '{{writeString=Gedropptes Element enthÃ¤lt keine Files}}');
				return false;
			}
			var target = jQuery(event.target);
			
			var i = 0;
			for(i=0;i<event.dataTransfer.files.length;i++) {
				file_upload.upload_file(event.dataTransfer.files.item(i), callback(target));
			}
			
			current_drag_is_file = false;
			return false;
		});
	},
	
	upload_file: function(file) {
		var options = {document_category_id: null, is_protected: false, language_id: null, document_id: null, name: file.name, type: file.type};
		jQuery.extend(options, arguments[1] || {});
		this.accepts(file.name, file.type, function(result, error) {
			if(error) {
				jQuery('<div/>').text(error.message).dialog();
			} else {
				this.do_upload(file, options);
			}
		});
	},
	
	do_upload: function(file, options) {
		var file_uploader = this;
		var fileReader = new FileReader();
		fileReader.onload = function() {
			file_uploader.uploadFile(window.btoa(fileReader.result), options, WidgetJSONOptions.with_upload_progess_callback(function(event) {
				console.log('uploaded', event);
			}), function(result, error) {
				if(!error) {
					Widget.notifyUser('info', '{{writeString=upload_success}}', {identifier: 'cmos.file_uploaded.into.'+options.document_category_id, closeDelay: false, closable: true});
					this.fire('{{writeString=file.uploaded}}', result);
				} else {
					Widget.notifyUser('alert', error.message);
				}
			});
		};
		fileReader.readAsBinaryString(file);
	}
};