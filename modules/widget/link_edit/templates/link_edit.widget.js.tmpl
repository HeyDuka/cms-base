Widget.types.link_edit = {
	prepare: function() {
		this.content = jQuery.parseHTML("{{includeTemplate=edit}}");
		var display_modes = this.getDisplayMode();
		var _this = this;
		jQuery.each(this.getConfigurationModes(), function(select_name, options) {
			var select_element = _this.content.find("select[name="+select_name+"]");
			jQuery.each(options, function(key, value) {
				var option = jQuery('<option/>').attr('value', key).text(value);
				if(display_modes[select_name] == key) {
					option.attr('selected', true);
				}
				select_element.append(option);
			});
		});
		this._element.append(this.content);

		var detail_widget;
		Widget.create('link_detail', function(widget) {
			_this.detail_widget = widget;
			widget.save_callback = _this.reload_preview.bind(_this);
		});
		
		this.result_list = jQuery('<ul/>');
		this.reload_preview();
		this._element.append(this.result_list);
		this.result_list.delegate('li', 'click', function() {
			var id = jQuery(this).data('id');
			_this.detail_widget.setLinkId(id);
			_this.detail_widget.fill_data();
			_this.detail_widget.open();
		});
	},
	
	reload_preview: function() {
		var _this = this;
		this.result_list.empty();
		this.allLinks(function(links) {
			jQuery.each(links, function(i, link) {
				_this.result_list.append(jQuery('<li/>').text(link.NAME).attr('title', "{{writeString=widget.edit_entry}}").data('id', link.ID));
			});
		});
	},
	
	save: function(callback) {
		this.saveData(this._element.serializeArrayKV(), callback);
	}
};