jQuery(document).ready(function() {
	var sidebar = AdminInterface.sidebar.find('.ui-list').getWidget();
	sidebar.settings.row_click_active_mode = 'activate';
	var initial_group_id = "{{writeRequestValue=group_id}}";
	if(initial_group_id) {
		initial_id = isNaN(initial_group_id) ? initial_group_id : parseInt(initial_group_id);
		var row = sidebar.row_from_row_data({id: initial_id});
		sidebar.activate_row(row);
	}	

	var user_list = AdminInterface.content.find('.user_list').getWidget();
	var initial_selection = "{{writeRequestValue=user_id}}";
	if(initial_selection) {
		initial_selection = isNaN(initial_selection) ? initial_selection : parseInt(initial_selection);
		console.log(initial_selection);
		var row = user_list.row_from_row_data({id: parseInt(initial_selection)});
		user_list.activate_row(row);
		// trigger detail widget
	}
	
	var info_bar = AdminInterface.info_bar.getWidget();
	info_bar.add_row_count_info_for_list(user_list);
	AdminInterface.info_bar.getWidget().add_button('add-new-item', function() {
		Widget.create('user_detail', function(widget) {
			widget.open();
			widget.save_callback = function() {
				jQuery('.user_list.ui-list').each(function() {
					jQuery(this).getWidget().reload();
				});
			};
		});
	}, 'n', true).add_button('add-new-item', function() {
		Widget.create('group_detail', function(widget) {
			widget.open();
			widget.save_callback = function() {
				jQuery('ul.ui-list').getWidget().reload()
			};
		});
	}).add_search_input("{{writeString=search.users}}", function(search) {
		if(user_list.setSearch(search)) {
			user_list.reload();
		}
	});
	
	sidebar.handle('list.row-click', function(event, row, element) {
		// jQuery('.ui-dialog').hide();
		var group_id = element.data('id');
		if(!element.hasClass('ui-state-active')) {
			// handle toggle of custom list elements and group_id properly
		 	group_id = null;
		}
		user_list.setOption('group_id', group_id);
		user_list.reload();
	});
	// add row_count_info
	info_bar.add_row_count_info_for_list(user_list);

});