jQuery(document).ready(function() {
	var sidebar = AdminInterface.sidebar.find('.ui-list').getWidget();
	sidebar.settings.row_click_active_mode = 'activate';
	var initial_group_id = "{{writeRequestValue=group_id}}";
	if(initial_group_id) {
		initial_id = isNaN(initial_group_id) ? initial_group_id : parseInt(initial_group_id);
		var row = sidebar.row_from_row_data({id: initial_id});
		sidebar.activate_row(row);
	}	

	var user_list = AdminInterface.content.find('.user_list').getWidget();
	var initial_user_id = "{{writeRequestValue=user_id}}";
	if(initial_user_id) {
		var row = user_list.row_from_row_data({id: parseInt(initial_user_id)});
		user_list.activate_row(row);
		// trigger detail widget
	}
	
	var info_bar = AdminInterface.info_bar.getWidget();
	var row_count_info = info_bar.get_row_count_info();
	AdminInterface.info_bar.getWidget().add_button('add-new-item', function() {
		Widget.create('user_detail', function(widget) {
			widget.open();
			widget.save_callback = function() {
				jQuery('.user_list.ui-list').each(function() {
					jQuery(this).getWidget().reload();
				});
			};
		});
	}, 'n', true).add_button('add-new-item', function() {
		Widget.create('group_detail', function(widget) {
			widget.open();
			widget.save_callback = function() {
				jQuery('ul.ui-list').getWidget().reload()
			};
		});
	}).add_search_input("{{writeString=search.users}}", function(search) {
		if(user_list.setSearch(search)) {
			user_list.reload();
		}
	});
	
	info_bar.add_element(row_count_info, true);
	var list_reload_handler = function() {
		row_count_info.text("{{writeParameterizedString=list_count;total=$\{total\};current=$\{current\}}}".replace(/\$\{total\}/, this.getNumberOfRows()).replace('${current}', this.current_row_count()));
	};
	list_reload_handler.call(user_list);
	user_list.handle('list.reloaded', list_reload_handler);

	sidebar.handle('list.row-click', function(event, row, element) {
		// jQuery('.ui-dialog').hide();
		var group_id = element.data('id');
		if(!element.hasClass('ui-state-active')) {
			// handle toggle of custom list elements and group_id properly
		 	group_id = null;
		}
		user_list.setOption('group_id', group_id);
		user_list.reload();
	});

});