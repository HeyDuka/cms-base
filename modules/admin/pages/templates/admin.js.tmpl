jQuery(document).ready(function() {
	var page_detail = null;
	var initial_selection = "{{writeRequestValue=page_id}}";

	Widget.createWithElement('page_detail', function(event, widget) {
		page_detail = widget;
		page_detail.load_page(initial_selection);
		AdminInterface.content.append(widget._element);
		jQuery("#accordion").accordion({ active: 0 });
	}, jQuery.noop);
	
	// init main content
	var page_tree = null;
	var click_handler = function(event, row, page_id) {
		page_detail.load_page(page_id);
		console.log(this.page_tree);
		// this.open_item(this._element);
	};
	
	Widget.createWithElement('tree', function(event, widget) {
		page_tree = widget;
		AdminInterface.sidebar.append(widget._element);
		widget.handle('tree.clicked', click_handler);
	}, function(widget) {
		widget.settings.description_from_item = function(item) {
			return item.Name;
		};
		widget.settings.has_children = function(item) {
			return item.TreeRight-item.TreeLeft > 1;
		};
		widget.settings.data_from_element = function(item) {
			return item.data('tree-data').Id;
		};
	}, '{{writeRequestValue=tree_session}}');
	var info_bar = AdminInterface.info_bar.getWidget();
	info_bar.add_button('add-new-item', function() {
		Widget.create('page_detail', function(widget) {
			widget.open();
			widget.save_callback = function() {
				jQuery('.ui-tree').each(function() {
					jQuery(this).getWidget().reload();
				});
			};
		});
	}, 'n', false).
	add_element(jQuery("{{includeTemplate=infobar_button.incl}}").text("{{writeString=widget.save}}").attr('name', 'save'), true, false).
	add_element(jQuery("{{includeTemplate=infobar_button.incl}}").text("{{writeString=widget.cancel}}").attr('name', 'cancel'), true, false).
	add_element(jQuery("{{includeTemplate=infobar_button.incl}}").text("{{writeString=widget.page.delete}}").attr('name', 'delete'), true, false);

	// init language change
	Widget.handle('cmos.language_changed', function() {
		console.log('test');
		// reload the sidebar and page detail
	});
});


